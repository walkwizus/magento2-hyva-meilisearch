<?php

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\LucideIcons;
use Walkwizus\MeilisearchFrontend\ViewModel\Ssr;
use Walkwizus\MeilisearchFrontend\ViewModel\Ssr\Pagination;

/** @var \Magento\Framework\View\Element\Template $block */
/** @var \Magento\Framework\Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

$ssr = $viewModels->require(Ssr::class);
$paginationViewModel = $viewModels->require(Pagination::class);
$lucideIcons = $viewModels->require(LucideIcons::class);

$searchResult = $ssr->getSearchResult();
$config = $ssr->getConfig();
$currentCategoryUrl = $config['currentCategoryUrl'] ?? $config['baseUrl'];

if (!$paginationViewModel->hasPagination($searchResult)) {
    return;
}

$currentPage = $paginationViewModel->getCurrentPage($searchResult);
$lastPageNum = $paginationViewModel->getLastPageNum($searchResult);
$framePages = $paginationViewModel->getFramePages($searchResult);

$pagerItemClass = "btn btn-secondary border-1 border-gray-300 rounded-3xl p-2 text-sm min-w-9.5 flex items-center justify-center";
$pagerIconSize = 20;
?>

<nav class="pages flex justify-center order-2 col-span-4 gap-1" aria-label="<?= $escaper->escapeHtmlAttr(__('pagination')) ?>">
    <a
        href="<?= $escaper->escapeUrl($paginationViewModel->getPageUrl($currentCategoryUrl, max(1, $currentPage - 1))) ?>"
        class="pages-item-previous <?= $escaper->escapeHtmlAttr($pagerItemClass) ?>"
        :class="!canGoPrev ? 'text-gray-400 border-gray-200 cursor-not-allowed pointer-events-none' : 'text-gray-700'"
        @click.prevent="prevPage()"
        aria-label="<?= $escaper->escapeHtmlAttr(__('Previous Page')) ?>"
    >
        <?= $lucideIcons->arrowLeftHtml('', $pagerIconSize, $pagerIconSize, ['aria-hidden' => 'true']); ?>
    </a>

    <ol class="inline-flex gap-1 items-center pages-items" x-show="!$store.meilisearch.isHydrated">
        <?php if ($paginationViewModel->canShowFirst($framePages)): ?>
            <li class="item">
                <a href="<?= $escaper->escapeUrl($paginationViewModel->getPageUrl($currentCategoryUrl, 1)) ?>" class="<?= $escaper->escapeHtmlAttr($pagerItemClass) ?>">1</a>
            </li>
        <?php endif; ?>

        <?php if ($paginationViewModel->canShowPreviousJump($framePages)): ?>
            <li class="item"><span class="<?= $escaper->escapeHtmlAttr($pagerItemClass) ?> border-none">...</span></li>
        <?php endif; ?>

        <?php foreach ($framePages as $page): ?>
            <li class="item">
                <a href="<?= $escaper->escapeUrl($paginationViewModel->getPageUrl($currentCategoryUrl, $page)) ?>"
                   class="<?= $escaper->escapeHtmlAttr($pagerItemClass) ?> <?= $page === $currentPage ? 'bg-gray-100 border-primary font-bold' : '' ?>"
                    <?= $page === $currentPage ? 'aria-current="page"' : '' ?>
                >
                    <?= $escaper->escapeHtml($page) ?>
                </a>
            </li>
        <?php endforeach; ?>

        <?php if ($paginationViewModel->canShowNextJump($framePages, $lastPageNum)): ?>
            <li class="item"><span class="<?= $escaper->escapeHtmlAttr($pagerItemClass) ?> border-none">...</span></li>
        <?php endif; ?>

        <?php if ($paginationViewModel->canShowLast($framePages, $lastPageNum)): ?>
            <li class="item">
                <a href="<?= $escaper->escapeUrl($paginationViewModel->getPageUrl($currentCategoryUrl, $lastPageNum)) ?>" class="<?= $escaper->escapeHtmlAttr($pagerItemClass) ?>">
                    <?= $escaper->escapeHtml($lastPageNum) ?>
                </a>
            </li>
        <?php endif; ?>
    </ol>

    <ol class="inline-flex gap-1 items-center pages-items" x-cloak x-show="$store.meilisearch.isHydrated">
        <template x-for="page in visiblePages" :key="page">
            <li class="item">
                <a
                    :href="'?page=' + page"
                    class="<?= $escaper->escapeHtmlAttr($pagerItemClass) ?>"
                    :class="page === currentPage ? 'bg-gray-100 border-primary font-bold' : ''"
                    :aria-current="page === currentPage ? 'page' : null"
                    @click.prevent="goToPage(page)"
                    x-text="page"
                ></a>
            </li>
        </template>
    </ol>

    <a
        href="<?= $escaper->escapeUrl($paginationViewModel->getPageUrl($currentCategoryUrl, min($lastPageNum, $currentPage + 1))) ?>"
        class="pages-item-next <?= $escaper->escapeHtmlAttr($pagerItemClass) ?>"
        :class="!canGoNext ? 'text-gray-400 border-gray-200 cursor-not-allowed pointer-events-none' : 'text-gray-700'"
        @click.prevent="nextPage()"
        aria-label="<?= $escaper->escapeHtmlAttr(__('Next Page')) ?>"
    >
        <?= $lucideIcons->arrowRightHtml('', $pagerIconSize, $pagerIconSize, ['aria-hidden' => 'true']); ?>
    </a>
</nav>
